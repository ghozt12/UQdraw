<html>
<head>
  <!-- CSS -->
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/vendor/gridism.css">
  <!-- Sets it as a mobile viewport if the user is on a mobile device -->
  <meta name="viewport" content="width=device-width,initial-scale=1">

</head>
<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js">	</script>-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js "></script>
<script type='text/javascript'>
	var courseID ="";
	var haveImage =0;// set to 1 if a image is imported
	var fileFormat ="";
	var title ="";
	var imageBlob ="";
	$(document).ready(function() {
		$.ajax({//retrieve JSON through ajax, if the parameter(courseID) from url is wrong, noting shows
			type: 'GET',
			url: 'http://teamone.uqcloud.net/uqDrawBackend/retrieveQuestionsfromCourseId.php?courseID='+getParameterByName("courseID"),
			success: function(data){
				//alert(data);
				//alert("success");
				var questionsListObject = JSON.parse(data);
				if(questionsListObject.success==1) {
					courseID = questionsListObject.subjectFull;
					document.getElementById("code").textContent = questionsListObject.enteringCode;// 3 digit code
					document.getElementById("subject").textContent = questionsListObject.subject;// course code
					var questionListHTML = "";
					for (var i = 0; i < questionsListObject.questionsList.length; i++) {//generate all question from JSON
						var question = questionsListObject.questionsList[i];
						questionListHTML += getQuestionItem(question);
					}
					document.getElementById("questionsList").innerHTML = questionListHTML;
				}else{alert("Fail to retrieve data please signon");}
			},
			error: function(){
				alert('There was an error adding your comment');
			}
		});
	});
	function getParameterByName(name) { // get url parameter
		name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results = regex.exec(location.search);
		return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}
	function getQuestionItem(questionItem){ // input the question Object from JSON array, output a HTML List Item
 //"<p>Lecture</p>"+questionItem.quwstionWeek+
		return	"<li> <span>" +questionItem.title+ "</span>" +
		"<button class='q-button' onclick='deleteQuestion("+questionItem.questionID+")'>DELETE</button> " +
		"<button class='q-button-long'>VIEW RESPONSES</button> " +
		"<button class='q-button'>EDIT</button> ";
	}
	function addQuestion(){
		document.getElementById("addButton").innerHTML ="";
		document.getElementById("addButton").innerHTML =/*"<li><form id ='addSubjectForm' class='subject-form'><span>Title:<input style='width:70%;'type='text' name='title' >" +
				"<button  type='submit' id ='addButton';class= 'q-button' '>Add</button>" +
				"<button  class= 'q-button' onclick='parseImage()'>Image</button></span></form></li>";*/
				"<li><span>Title:<input style='width:70%;'type='text' name='title' >" +
				"<button  class='q-button' onclick='submitCourse()' >Add</button>" +
				"<input  type='file' onchange='parseImage()''></span></li>" +
				"<li><img id='preview'src='' height='500px' width='500px' alt='Image preview...'></li>";
				//"<textarea id='base64textarea' placeholder='Base64 will appear here' cols='50' rows='15'></textarea>";
	}

	function parseImage(){
	//Change image to blob}
		var preview = document.getElementById('preview'); //preview box
		var file    = document.querySelector('input[type=file]').files[0]; //sames as here
		var reader  = new FileReader();
		var canvas = document.createElement("canvas"),
		canvasContext = canvas.getContext("2d");
		haveImage = true;//set true if validate as a image

		reader.onloadend = function (readerEvt) {
			preview.src = reader.result; // show the upload photo on .preview
		}

		if (file) {
			reader.readAsDataURL(file)//reads the data as a URL

		} else {
			preview.src = "";
		}
		preview.onload = function () {
			//Set canvas size is same as the picture
			canvas.width = preview.width;
			canvas.height = preview.height;

			// draw image into canvas element
			canvasContext.drawImage(preview, 0, 0, preview.width, preview.height);

			// get canvas contents as a data URL (returns png format by default)
			var dataURL = canvas.toDataURL();
            imageBlob = dataURL; // image blob reference that are going to POST
		};
		console.log(imageBlob);
	}




	function getCurrentWeek(){
		var d =new Date();//to be discuss
		return 1;
	}

	function submitCourse(){ //ajax Post
	//$("#addButton").click(function(){
		title = document.getElementsByName("title")[0].value;
		if(title!="") {
			var DataObj = {
				courseID: courseID,
				title: title,
				haveImage: haveImage,
				fileFormat: ".jpg", // since it is blob, no matter it is .jpg / .png, it will still saved in .png format
				image: imageBlob,
				questionWeek: getCurrentWeek()
			};
			$.post('../uqDrawBackend/addQuestion.php', DataObj, function (data) {//url must be in file path, Can't POST data through HTTP
				alert(data);
				location.reload();// reload page when data is inserted

			}).fail(function () {
				// just in case posting your form failed
				alert("Posting failed.");

			});
		}else{alert("Type something, dude");}
	}

	function deleteQuestion(questionID){
		
		$(document).ready(function(){
			$.ajax({//delete question through ajax so it updates instantly
				type: "POST",
				url: '../uqDrawBackend/deleteQuestion.php',
				data: {
					questionID: questionID,
				},
				success:function(result){
					alert(result);
					location.reload();

				},
				error:function(){
					alert("Can't Reach server")
				}
			});
		});
	}
</script>
<body class="bg-prepare">
	<!-- Header -->
	<section>
		<div class='header-l-prepare'>
			<!-- Back button -->
			<a href='lecture-prepare.html'><div class='button-back-prepare'> <p> Go Back </p></div></a>
			<!-- Logo (small) -->
			<div class="headerpos">
			<a href="#"><img class='images-l-subjects' src='../assets/images/topbar-logo.png' /></a>
			<!-- Title of the page -->
			<h3 class='type-title'> Create Questions </h3>
			</div>
			<!-- Switch button -->
			<a href='lecture-questions.html'><div class='button-goto-lecture'> <p> Goto Lecture Mode </p></div></a>
		
		</div>
	</section>

	<!-- Body -->
	<section>
		<!-- Body Heading -->
		<h2 class="type-body-heading"> <span id="subject"> MATH 1061 </span>  CODE: <span id="code">3FC</span> </h2>
		<!-- Body Subheading -->
		<h3 class="type-body-subheading"> Click the plus button to create a new question </h3>
		<!-- List the Questions -->
		<ul class="list-make-green">
			<span id="questionsList">
			<label>Lecture 1</label>
			<!-- Place PHP here, for each question in db, create a <li> element -->
			<li> 
				<div class="question-container">
				<div class="question">
					Question 1: Draw a house aaaaaaaaa aaaaaaa aaaaaa aaaaa aaa aaaaaa 
				</div>
				<div class="question-button">
					<button class="make-button">Delete</button>
					<button class="make-button-long">View Responses</button>
					<button class="make-button">Edit</button> 
				</div>
			</li>

			<li> 
				<div class="question-container">
				<div class="question">
					Question 2: Draw a house aaaaaaaaa aaaaaaa aaaaaa aaaaa aaa aaaaaa 
				</div>
				<div class="question-button">
					<button class="make-button">Delete</button>
					<button class="make-button-long">View Responses</button>
					<button class="make-button">Edit</button> 
				</div>
			</li>

			<li> 
				<div class="question-container">
				<div class="question">
					Question 3: Draw a house a
				</div>
				<div class="question-button">
					<button class="make-button">Delete</button>
					<button class="make-button-long">View Responses</button>
					<button class="make-button">Edit</button> 
				</div>
			</li>

			
			<!-- Create new question button -->
			</span>
		</ul>
			<ul id="addButton"><li onclick="addQuestion()"><button class="button-add">+</button></li></ul>
	</section>

</body>
	<!-- Library -->


	<!-- JS -->
</html>